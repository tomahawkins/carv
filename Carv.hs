-- Trying to discover how CARV metrics are weighted
-- to compute the final SkiIQ score.
module Carv (reportAll) where

import Numeric.LinearAlgebra
  ( Matrix,
    Vector,
    asRow,
    atIndex,
    toLists,
    vector,
    (#>),
    (<\>),
    (><),
  )
import Text.Printf (printf)

-- Carv data, either a segment or a single turn.
data Carv = Carv
  { skiIq,
    pitch,
    turnShape,
    parallelSkis,
    earlyEdging,
    midTurnEdgeBuild,
    edgingSimilarity,
    edgeAngle,
    earlyForwardMovement,
    midTurnBalance,
    transitionWeightRelease,
    gForce ::
      Double
  }
  deriving (Show)

reportAll :: IO ()
reportAll = do
  putStrLn "\n\nGeneral segments data:\n"
  report segments
  putStrLn "\n\nJC's turn-by-turn data:\n"
  report jc

-- A matrix of metrics.  E.g.
--  [ [Pitch1, TurnShape1, ParallelSkis1, EarlyEdging1, ..., GForce1],
--    [Pitch2, TurnShape2, ParallelSkis2, EarlyEdging2, ..., GForce2],
--    [Pitch3, TurnShape3, ParallelSkis3, EarlyEdging3, ..., GForce3]
--  ]
metrics :: [Carv] -> Matrix Double
metrics carv =
  (length carv >< 11) $
    concat
      [ [tan' a0, a1, a2, a3, a4, a5, tan' a6, a7, a8, a9, a10]
        | Carv _ a0 a1 a2 a3 a4 a5 a6 a7 a8 a9 a10 <- carv
      ]

tan' :: Double -> Double
-- tan' a = tan $ a * pi / 180
tan' a = a

-- A vector of the resulting SkiIQs.
skiIqs :: [Carv] -> Vector Double
skiIqs carv = vector $ skiIq <$> carv

-- The general idea:  Each metric is weighted when computing the final SkiIQ.
--
--  SkiIqVector = MetricsMatrix * WeightsVector
--

-- Report what we find.
report :: [Carv] -> IO ()
report carv =
  putStrLn $
    unlines $
      [ "",
        "Weights:",
        "",
        printf "  Pitch                      : % .2f" (weights `atIndex` 0),
        printf "  Turn Shape                 : % .2f" (weights `atIndex` 1),
        printf "  Parallel Skis              : % .2f" (weights `atIndex` 2),
        printf "  Early Edging               : % .2f" (weights `atIndex` 3),
        printf "  Mid Turn Edge Build        : % .2f" (weights `atIndex` 4),
        printf "  Edging Similarity          : % .2f" (weights `atIndex` 5),
        printf "  Edge Angle                 : % .2f" (weights `atIndex` 6),
        printf "  Early Forward Movement     : % .2f" (weights `atIndex` 7),
        printf "  Mid Turn Balance           : % .2f" (weights `atIndex` 8),
        printf "  Transition Weight Release  : % .2f" (weights `atIndex` 9),
        printf "  G Force                    : % .2f" (weights `atIndex` 10),
        "",
        printf "Average Error : %.2f" $ sum (abs <$> err) / fromIntegral (length err),
        ""
      ]
  where
    m = metrics carv
    siq = skiIqs carv
    weights = m <\> siq
    siq' = m #> weights
    err :: [Double]
    err = concat $ toLists $ asRow $ siq' - siq

segments :: [Carv]
segments =
  [ -- World leaders.
    Carv 178 31 86 80 97 87 72 70 54 64 100 2.2,
    Carv 177 27 84 83 91 94 91 69 57 60 100 2.4,
    Carv 176 33 89 80 83 78 95 69 57 66 100 2.0,
    Carv 176 26 87 83 100 94 81 71 70 86 100 2.6,
    Carv 175 27 94 82 90 88 84 69 59 75 100 2.2,
    -- SkiTalk leaders.
    Carv 170 21 91 82 78 98 91 66 61 75 95 2.3,
    Carv 168 19 95 95 75 98 97 67 43 59 80 1.9,
    Carv 167 15 90 91 92 100 100 66 61 72 74 2.0,
    Carv 165 13 84 95 82 94 95 63 66 72 82 2.2,
    Carv 163 16 83 81 84 98 82 66 60 72 97 2.4,
    Carv 162 21 85 93 79 94 93 60 61 64 89 2.2,
    Carv 162 21 93 91 87 94 93 62 56 66 100 1.9,
    -- Feb 13th.
    Carv 148 12 85 89 75 83 92 57 49 64 78 1.6,
    Carv 158 18 80 92 73 93 85 63 41 54 72 1.9,
    Carv 157 18 86 88 77 92 89 63 42 76 81 1.9,
    Carv 155 19 88 90 75 95 88 63 47 63 76 1.9,
    Carv 159 18 97 91 73 93 90 66 50 64 76 1.9,
    Carv 145 18 67 86 59 65 86 45 70 92 56 1.7,
    Carv 151 23 60 86 57 65 87 44 87 100 86 2.0,
    Carv 145 12 81 94 62 73 95 48 65 81 47 1.3,
    Carv 129 32 39 74 46 38 36 30 40 54 73 0.9,
    Carv 128 19 62 88 58 55 71 39 41 58 70 1.2,
    Carv 155 16 84 90 81 93 91 63 49 67 82 2.1,
    Carv 140 13 74 92 58 81 85 50 41 60 68 1.5,
    Carv 147 14 81 93 66 72 90 50 59 82 57 1.6,
    Carv 156 13 80 92 86 85 95 61 56 81 95 1.9,
    Carv 152 16 83 92 79 88 93 61 58 76 73 1.8,
    Carv 156 10 84 94 74 86 90 57 51 80 87 1.8,
    Carv 148 8 74 88 85 86 98 63 63 73 73 1.8
  ]

-- JC's data.
jc :: [Carv]
jc =
  [ Carv 146 18 64 70 52 89 64 65 33 45 90 1.7,
    Carv 149 18 78 73 57 84 69 57 42 59 100 1.8,
    Carv 160 18 42 74 62 89 87 59 53 84 100 2.1,
    Carv 151 18 57 87 69 80 75 57 46 40 100 2.0,
    Carv 141 18 54 88 52 91 73 60 36 75 91 2.0,
    Carv 149 18 46 90 54 80 98 56 64 100 100 2.1,
    Carv 148 18 35 72 55 73 97 48 85 89 66 2.3,
    Carv 140 18 58 84 60 81 85 54 78 74 86 1.8,
    Carv 149 16 57 82 59 95 95 62 41 53 74 1.7,
    Carv 148 16 67 92 59 74 97 49 73 66 44 1.4,
    Carv 146 16 71 75 70 94 86 65 43 69 74 1.8,
    Carv 148 16 63 85 71 71 98 50 71 77 62 1.6,
    Carv 152 16 35 73 61 93 84 62 68 72 73 1.8,
    Carv 150 16 89 78 47 81 92 55 66 66 58 1.8,
    Carv 147 16 67 87 53 90 86 61 55 82 74 1.8,
    Carv 151 16 58 86 68 84 73 56 74 96 78 2.0,
    Carv 142 16 58 73 54 85 80 54 46 67 63 1.5,
    Carv 145 16 92 72 67 86 81 54 57 79 83 1.6,
    Carv 149 20 54 72 46 91 70 62 41 84 50 1.9,
    Carv 153 20 23 73 74 94 61 63 68 86 72 2.0,
    Carv 152 20 64 86 51 100 83 64 56 49 65 1.8,
    Carv 147 20 63 77 76 91 56 61 38 47 53 2.0,
    Carv 151 20 87 80 67 91 78 68 72 78 78 1.5,
    Carv 143 20 74 89 57 85 55 52 23 49 48 1.5,
    Carv 153 20 79 89 55 96 77 60 54 55 81 1.8,
    Carv 141 20 66 85 64 81 56 51 51 72 66 1.5,
    Carv 150 17 52 75 58 88 73 60 28 36 96 1.8,
    Carv 148 17 73 71 63 88 73 57 43 65 100 1.8,
    Carv 143 17 43 80 62 89 55 56 32 45 97 1.6,
    Carv 146 17 47 83 48 90 77 57 32 63 100 1.8,
    Carv 143 17 40 82 75 86 67 56 58 91 83 1.9,
    Carv 143 17 28 75 58 79 70 54 57 72 92 2.0,
    Carv 130 17 41 74 39 31 44 50 31 40 95 1.6,
    Carv 115 17 30 52 39 20 62 30 20 37 61 0.7,
    Carv 140 17 28 66 62 86 66 60 57 50 57 1.6,
    Carv 148 17 58 82 68 81 91 52 68 73 68 1.6,
    Carv 146 17 59 90 65 86 76 60 67 69 34 1.6,
    Carv 139 17 64 85 53 73 73 47 33 48 55 1.4,
    Carv 138 17 41 83 53 81 56 55 66 100 61 1.3,
    Carv 141 17 78 94 42 71 75 49 38 70 61 1.6,
    Carv 146 17 36 74 84 86 75 57 61 84 78 1.6,
    Carv 146 17 57 91 46 74 81 51 81 98 69 1.7,
    Carv 144 17 25 81 56 75 77 51 70 92 63 2.0,
    Carv 133 17 61 87 56 82 73 57 71 100 62 1.7,
    Carv 132 17 34 88 46 23 48 32 69 89 47 1.1,
    Carv 122 17 83 73 24 47 41 35 54 50 65 0.7,
    Carv 144 15 67 85 52 91 96 61 67 65 48 1.4,
    Carv 147 15 81 86 73 80 96 48 55 73 58 1.5,
    Carv 142 15 71 80 64 93 68 60 50 52 52 1.5,
    Carv 148 15 93 88 53 86 86 57 45 35 62 1.4,
    Carv 149 15 82 83 64 85 81 62 35 37 82 1.7,
    Carv 154 15 92 88 51 89 76 63 61 53 86 1.5,
    Carv 147 15 68 78 61 90 76 57 50 57 62 1.6,
    Carv 149 15 92 87 59 95 77 64 51 50 74 1.7,
    Carv 140 16 48 76 59 9 70 62 54 68 59 1.6,
    Carv 145 16 82 77 55 73 93 51 48 44 54 1.4,
    Carv 153 16 80 85 66 95 88 68 69 72 64 1.7,
    Carv 148 16 84 76 56 83 89 55 69 57 53 1.5,
    Carv 151 16 71 81 70 90 81 65 43 62 73 1.7,
    Carv 153 16 63 73 57 87 99 57 52 51 84 1.7,
    Carv 153 16 49 78 49 91 84 56 63 56 88 1.7,
    Carv 146 16 93 80 68 94 88 61 65 65 67 1.6,
    Carv 141 16 62 72 59 81 86 52 71 86 75 1.6,
    Carv 145 16 61 82 51 87 80 64 56 53 62 1.5,
    Carv 139 16 71 74 54 69 89 51 49 53 60 1.4,
    Carv 150 16 62 83 64 100 86 64 34 59 52 1.7,
    Carv 147 16 71 68 54 80 92 49 53 51 70 1.6,
    Carv 148 16 72 83 78 92 86 66 47 61 65 1.5,
    Carv 152 16 93 66 76 90 90 59 53 61 68 1.6,
    Carv 161 16 69 82 62 97 87 66 53 73 100 1.8,
    Carv 145 16 58 80 51 82 78 58 57 72 79 2.1,
    Carv 144 16 72 71 56 84 95 53 87 90 56 1.7,
    Carv 122 16 38 64 48 73 75 48 50 44 54 1.1,
    Carv 137 21 89 79 30 76 73 48 53 46 61 1.1,
    Carv 147 21 35 71 47 96 83 66 55 70 55 1.6,
    Carv 142 21 62 77 50 72 69 47 40 51 66 1.4,
    Carv 147 21 78 80 50 91 85 59 45 44 69 1.3,
    Carv 148 21 100 73 49 79 88 56 48 43 65 1.3,
    Carv 150 21 64 71 49 86 88 61 55 65 88 1.4,
    Carv 147 21 75 81 51 89 84 59 45 48 81 1.6,
    Carv 137 21 81 73 61 80 78 55 52 56 68 1.4,
    Carv 148 17 58 71 51 100 91 64 38 55 57 1.6,
    Carv 142 17 70 72 39 77 81 47 43 36 82 1.3,
    Carv 152 17 79 80 52 96 91 60 31 56 65 1.6,
    Carv 144 17 79 70 51 82 82 52 37 43 75 1.3,
    Carv 157 17 59 71 63 91 93 63 54 67 100 1.4,
    Carv 147 17 60 74 58 84 85 60 47 46 71 1.6,
    Carv 144 17 88 77 51 76 98 50 63 73 54 1.2,
    Carv 137 17 76 74 0 13 66 33 20 18 58 0.6,
    Carv 138 16 43 75 40 66 91 40 64 63 48 0.9,
    Carv 136 16 64 72 45 75 78 51 51 76 47 1.3,
    Carv 143 16 44 72 57 74 98 46 59 62 29 1.7,
    Carv 144 16 61 74 57 84 77 53 54 49 85 1.5,
    Carv 148 16 42 86 61 79 99 55 87 89 66 1.7,
    Carv 148 16 26 75 69 86 81 57 100 100 56 2.3,
    Carv 150 16 59 89 65 85 88 56 88 69 65 1.8,
    Carv 152 16 59 82 65 77 100 52 74 98 46 1.9,
    Carv 151 16 42 81 71 88 100 58 80 83 65 1.9,
    Carv 150 16 47 87 70 73 95 53 70 100 37 1.9,
    Carv 145 16 81 88 56 78 100 51 60 77 68 1.5,
    Carv 138 18 94 95 50 72 76 50 29 65 55 0.9,
    Carv 136 18 93 94 52 54 75 36 27 45 41 1.0,
    Carv 143 18 70 82 48 70 65 55 52 57 74 1.4,
    Carv 159 18 78 88 61 93 100 62 57 68 54 1.7,
    Carv 155 18 71 96 58 94 79 59 55 85 79 1.7,
    Carv 157 18 84 93 71 94 93 61 61 51 51 2.3,
    Carv 153 18 69 95 80 91 96 61 69 79 65 1.8,
    Carv 151 18 73 97 66 93 89 60 75 70 65 2.2,
    Carv 138 18 64 89 68 86 78 53 50 53 75 1.7,
    Carv 150 18 91 95 68 77 95 52 79 98 59 1.7,
    Carv 141 18 42 78 69 87 79 56 59 82 62 2.0,
    Carv 146 18 76 89 48 75 84 49 75 93 72 2.0,
    Carv 149 18 69 92 67 83 74 54 43 75 75 1.8,
    Carv 157 18 85 93 68 88 87 56 53 82 88 1.8,
    Carv 151 18 98 85 55 84 92 56 61 57 91 1.6,
    Carv 147 18 95 88 56 89 72 59 56 90 78 1.7,
    Carv 147 18 79 82 49 81 72 58 36 45 83 1.7,
    Carv 149 18 82 88 58 88 72 58 52 54 88 1.5,
    Carv 151 18 82 83 61 88 80 60 46 71 66 1.8,
    Carv 142 18 75 91 53 82 57 53 49 57 81 1.5,
    Carv 149 18 77 96 54 88 77 54 47 64 73 1.7,
    Carv 136 18 82 90 52 60 71 42 40 57 51 0.8,
    Carv 136 18 84 70 48 65 86 42 46 59 26 0.9,
    Carv 146 18 82 88 64 86 76 60 49 55 52 1.1,
    Carv 138 18 56 70 41 61 84 38 45 58 56 1.2,
    Carv 147 18 62 89 61 91 89 60 57 90 98 1.5,
    Carv 155 18 73 80 57 94 94 59 64 50 75 1.6,
    Carv 149 18 76 84 47 90 83 62 29 49 72 1.8,
    Carv 154 18 40 78 76 99 85 67 52 68 71 1.9,
    Carv 150 18 55 75 64 88 70 58 58 77 61 1.7,
    Carv 152 18 62 70 61 92 93 61 60 55 74 1.8,
    Carv 144 18 57 80 55 88 69 56 43 46 66 1.7,
    Carv 149 18 73 79 54 89 90 57 74 70 61 1.7,
    Carv 144 18 77 79 58 79 77 57 54 64 61 1.7,
    Carv 145 16 57 93 73 90 95 66 72 97 53 1.9,
    Carv 148 16 74 84 59 77 85 51 62 66 96 1.9,
    Carv 155 16 65 83 77 100 86 70 48 62 59 2.2,
    Carv 142 16 79 75 54 78 80 51 41 48 80 1.6,
    Carv 148 16 67 79 65 96 82 66 63 83 62 1.7,
    Carv 150 16 89 84 64 83 88 54 34 64 65 1.6,
    Carv 153 16 83 89 79 94 79 65 61 61 75 1.8,
    Carv 152 16 49 84 78 87 89 58 58 81 81 2.0,
    Carv 144 16 74 82 81 77 74 53 65 72 72 1.7,
    Carv 137 16 65 78 58 83 70 56 75 64 95 1.3,
    Carv 159 15 63 93 67 97 96 72 60 69 81 2.0,
    Carv 142 15 58 72 54 78 95 46 34 43 52 1.6,
    Carv 154 15 69 77 76 100 90 71 62 79 51 1.9,
    Carv 141 15 70 82 64 73 72 47 67 85 66 1.6,
    Carv 153 15 58 83 79 97 83 66 48 76 74 1.9,
    Carv 149 15 63 69 69 80 90 54 48 61 76 1.5,
    Carv 153 15 73 84 62 96 67 63 72 69 74 1.7,
    Carv 152 15 56 79 53 87 93 54 50 60 78 1.9,
    Carv 143 15 41 77 39 79 63 56 51 79 66 2.5,
    Carv 146 15 67 87 71 84 89 54 72 68 75 1.5,
    Carv 145 15 66 92 79 80 83 53 43 82 58 1.9,
    Carv 150 14 66 85 83 99 79 71 69 80 68 2.1,
    Carv 148 14 50 73 73 77 91 56 60 78 64 2.1,
    Carv 151 14 32 88 81 100 78 71 95 97 67 2.3,
    Carv 149 14 55 58 77 80 86 57 63 69 75 2.1,
    Carv 150 14 49 80 72 95 74 64 54 82 80 2.0,
    Carv 143 14 58 88 75 84 85 52 45 45 65 1.7,
    Carv 152 14 78 80 74 96 82 63 69 86 52 2.2,
    Carv 153 14 63 84 69 80 74 55 72 82 100 2.1,
    Carv 145 14 70 60 75 92 81 59 36 47 59 1.5,
    Carv 136 14 64 60 44 75 73 53 33 40 64 1.5
  ]
